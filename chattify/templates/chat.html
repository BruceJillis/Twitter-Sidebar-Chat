{% extends "layout.html" %}

{% block subtitle %} - Really simple webchat{% endblock %}

{% block css %} 
	#chat {
		width: 500px;
	}
	#chat #history {
		width: 100%;
		height: 250px;
		overflow-x: hidden;
		overflow-y: scroll;
		clear: both;
		float: left;
	}
	#chat #history .line {
		width: 100%;
		overflow: hidden;
		float: left;
		clear: both;
	}
	#chat #history .line .name {
		max-width: 80px;
		overflow: hidden;
		float: left;
	}
	#chat #history .line .text {
		float: left;
		margin-left: 5px;
		max-width: 420px;
		word-wrap: break-word;
	}
	#current {
		width: 100%;
		float: left;
		clear: both;
	}
	div.row {
		margin: 2px 0;
	}
	#current #line {
		float: left;		
		width: 89%;
	}
	input {
		height: 17px;
		margin: 2px 0px;
	}
	#current #send {
		width: 10%;
	}
{% endblock %}

{% block content %}
<script src='/_ah/channel/jsapi'></script>
<script>
	function Chat() {
		var state = {
			'key': '{{ key }}',
			'username': '{{ username }}'
		}
		
		function send() {
			// temporarily disable the button
			$('#send').button('disable');
			// don't send empty lines
			if( $('#line').val() == '' )
				return;
			// send current line
			interface.send('/say', 'username=' + state.username + '&msg=' + $('#line').val());
			// clean up
			$('#line').val('');
			// enable the button again
			$('#send').button('enable');
		}

		var interface = {
			'ready': function() {
				// create buttons
				$('.button').button();
				// send on press of the enter key
				$('#line').bind('keydown', function(ev) {
					if( ev.keyCode == 13 )
						send();
				});
				// send on click
				$('#send').bind('click', function(ev) {
					send();
				});
				// change the username
				$('#change').click(function() {
					document.location.href = "{{ host }}chat/{{ key }}/" + $('#new-username').val();
				});
			},
			'unload': function() {
				// leave the channel
				interface.send('/leave', 'username=' + state.username);
			},
			'error': function(msg, data) {
				// show error message
				$('.content', "#dialog-message").html(msg);
				$("#dialog-message").dialog({
					modal: true,
					buttons: {
						Ok: function() {
							$(this).dialog("close");
							document.location.href = '{{ host }}';
						}
					}
				});
			},
			'message': function(answer) {
				// send message on channel
				var data = eval('('+answer.data+')');
				if( 'error' in data ) 
					interface.error(data.error, data);
				else
					interface.line(data.username, data.msg)
			},
			'opened': function(answer) {
				// join the channel
				interface.send('/join', 'username=' + state.username, true);
			},
			'send': function(path, opt_param, sync) {
				if( sync == undefined )
					sync = false
				// send message
				path += '?key=' + state.key;
				if (opt_param)
					path += '&' + opt_param;
				var xhr = new XMLHttpRequest();
				xhr.open('POST', path, !sync);
				xhr.send();
			},
			'line': function(username, msg) {
				// add a new line to the buffer
				var markup = [
					'<div class="line">',
						'<div class="name">@',username,'</div>',
						'<div class="text">',msg,'</div>',
					'</div>'
				]
				$('#history').html( $('#history').html() + markup.join('') );
				$("#history").attr({ scrollTop: $("#history").attr("scrollHeight") });
			}
		}
		$(document).bind('ready', interface.ready)
		$(window).bind('unload', interface.unload)

		var channel = new goog.appengine.Channel('{{ token }}');
		var socket = channel.open();
		socket.onopen = interface.opened;
		socket.onmessage = interface.message;

		return interface;
	}
	var chat = new Chat();
</script>
<h3>Welcome, {{ username }}</h3>

<div id="chat">
	<div id="history">
	</div>
	<br class="clear"/>
	<div id="current" class="row">
		<input type="text" id="line" value"" />
		<button id="send" class="button">send</button>
	</div>
</div>

<br class="clear"/>
<div class="row">
	<button id="change" class="button" >Change Username</button>
	<input type="text" id="new-username" value="guest{{ users }}" size="40" />
</div>

<div id="dialog-message" title="Error" class="hidden">
	<p>
		<span class="ui-icon ui-icon-circle-check" style="float:left; margin:0 7px 50px 0;"></span>
		<span id="title">An error has occured:</span>
	</p>
	<p class="content">
		Please try again later.
	</p>
</div>
{% endblock %}