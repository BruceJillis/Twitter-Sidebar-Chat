{% extends "layout.html" %}

{% block subtitle %} - Really simple webchat{% endblock %}

{% block head %}
<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.min.js"></script>
<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8.7/jquery-ui.min.js"></script>
<script src='/_ah/channel/jsapi'></script>
{% endblock %}


{% block css %} 
	#chat {
		width: 500px;
	}
	#chat #history {
		width: 100%;
		height: 250px;
		overflow-x: hidden;
		overflow-y: scroll;
		clear: both;
		float: left;
	}
	#chat #history .line {
		width: 100%;
		overflow: hidden;
		float: left;
		clear: both;
	}
	#chat #history .line .name {
		max-width: 80px;
		overflow: hidden;
		float: left;
	}
	#chat #history .line .text {
		float: left;
		margin-left: 5px;
		max-width: 420px;
		word-wrap: break-word;
	}
	#current {
		width: 100%;
		float: left;
		clear: both;
	}
	#current #username {
		width: 53px;
		overflow: hidden;
		float: left;		
	}
	#current #line {
		float: left;		
		width: 400px;
	}
	#current #send {
		width: 43px;
	}
	.clear {
		clear: both;
	}
{% endblock %}

{% block js %}
	function Chat() {
		var state = {
			'key': '{{ key }}',
			'username': '{{ username }}'
		}

		var interface = {
			'ready': function() {
				// send button
				$('#send').button();
				$('#send').bind('click', function(ev) {
					// don't send empty lines
					if( $('#line').val() == '' )
						return;
					// send current line
					interface.send('/say', 'username=' + state.username + '&msg=' + $('#line').val());
					// clean up
					$('#line').val('')
				});
				// position chat widget
				$('#chat').position({
					'of': $('#chat').parent(),
					'my': 'center center',
					'at': 'center center'
				});
			},
			'unload': function() {
				// leave the channel
				interface.send('/leave', 'username=' + state.username);
			},
			'message': function(answer) {
				// send message on channel
				var data = eval('('+answer.data+')');
				interface.line(data.username, data.msg)
			},
			'opened': function(answer) {
				// join the channel
				interface.send('/join', 'username=' + state.username);
			},
			'send': function(path, opt_param) {
				// send message
				path += '?key=' + state.key;
				if (opt_param) {
					path += '&' + opt_param;
				}
				var xhr = new XMLHttpRequest();
				xhr.open('POST', path, true);
				xhr.send();
			},
			'line': function(username, msg) {
				// add a new line to the buffer
				var markup = [
					'<div class="line">',
						'<div class="name">@',username,'</div>',
						'<div class="text">',msg,'</div>',
					'</div>'
				]
				$('#history').html( $('#history').html() + markup.join('') );
				$("#history").attr({ scrollTop: $("#history").attr("scrollHeight") });
			}
		}
		$(document).bind('ready', interface.ready)
		$(window).bind('unload', interface.unload)

		var channel = new goog.appengine.Channel('{{ token }}');
		var socket = channel.open();
		socket.onopen = interface.opened;
		socket.onmessage = interface.message;

		return interface;
	}
	var chat = new Chat();
{% endblock %}

{% block content %}
<div id="chat">
	<div id="history">
	</div>
	<br class="clear"/>
	<div id="current">
		<div id="username">@{{username}}</div> <input type="text" id="line" value"" size="60" />
		<button id="send">send</button>
	</div>
</div>
{% endblock %}